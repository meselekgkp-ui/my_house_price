<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wohnungssuche</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            padding-top: 50px;
        }

        .form-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            width: 350px;
        }

        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        select,
        input {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            /* Wichtig damit Padding nicht die Breite sprengt */
        }

        .help-text {
            display: block;
            margin-top: 4px;
            font-size: 0.8rem;
            color: #666;
        }

        .error-text {
            color: #b00020;
        }

        /* DESIGN WUNSCH: Wohnungstyp ein bisschen schraeg */
        .schraeg-input {
            transform: skewX(-10deg);
            /* Neigt das Element */
            border: 1px solid #007BFF;
            /* Blaue Umrandung zur Hervorhebung */
        }

        /* DESIGN WUNSCH: Button mit hellem Text */
        button {
            margin-top: 20px;
            width: 100%;
            padding: 10px;
            background-color: #007BFF;
            /* Dunkler Hintergrund */
            color: #ffffff;
            /* Heller Text (Weiss) */
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
        }

        button:hover {
            background-color: #0056b3;
        }

        .row {
            display: flex;
            gap: 10px;
        }

        .checkbox-row {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 8px 12px;
            margin-top: 10px;
        }

        .checkbox-row label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: normal;
        }

        .result {
            margin-top: 16px;
            padding: 10px;
            border-radius: 6px;
            background: #eef4ff;
            color: #0b2b5b;
            font-weight: bold;
            display: none;
        }

        .error {
            margin-top: 10px;
            color: #b00020;
            font-size: 0.9rem;
        }
    </style>
</head>

<body>

    <div class="form-container">
        <h2>Immobiliensuche</h2>

        <form id="searchForm">
            <label for="bundesland">Bundesland:</label>
            <select id="bundesland" disabled>
                <option value="">-- Bitte waehlen --</option>
            </select>

            <label for="stadt">Stadt:</label>
            <select id="stadt" disabled>
                <option value="">-- Zuerst Bundesland waehlen --</option>
            </select>

            <label for="plz">Postleitzahl (PLZ):</label>
            <input type="text" id="plz" placeholder="z.B. 80331" maxlength="5" inputmode="numeric" pattern="\d{5}"
                disabled list="plzList">
            <datalist id="plzList"></datalist>
            <small id="plzHelp" class="help-text"></small>

            <label for="typ">Wohnungstyp:</label>
            <select id="typ" class="schraeg-input">
                <option value="Etagenwohnung">Etagenwohnung</option>
                <option value="Dachgeschoss">Dachgeschoss</option>
                <option value="Erdgeschoss">Erdgeschoss</option>
                <option value="Maisonette">Maisonette</option>
                <option value="Hochparterre">Hochparterre</option>
                <option value="Penthouse">Penthouse</option>
                <option value="Souterrain">Souterrain</option>
                <option value="Andere">Andere</option>
            </select>

            <div class="row">
                <div style="flex: 1;">
                    <label for="zimmer">Zimmer:</label>
                    <input type="number" id="zimmer" min="1" max="10" step="0.5" placeholder="2.5">
                </div>
                <div style="flex: 1;">
                    <label for="etage">Etage:</label>
                    <input type="number" id="etage" min="-1" max="20" placeholder="EG = 0">
                </div>
            </div>

            <div class="row">
                <div style="flex: 1;">
                    <label for="flaeche">Wohnflaeche (m2):</label>
                    <input type="number" id="flaeche" min="10" max="500" placeholder="z.B. 60">
                </div>
                <div style="flex: 1;">
                    <label for="baujahr">Baujahr:</label>
                    <input type="number" id="baujahr" min="1800" max="2100" placeholder="z.B. 1998">
                </div>
            </div>

            <label for="heizung">Heizung:</label>
            <select id="heizung">
                <option value="Zentralheizung">Zentralheizung</option>
                <option value="Fernwaerme">Fernwaerme</option>
                <option value="Gas-Heizung">Gas-Heizung</option>
                <option value="Etagenheizung">Etagenheizung</option>
                <option value="Fussbodenheizung">Fussbodenheizung</option>
                <option value="Oelheizung">Oelheizung</option>
                <option value="Waermepumpe">Waermepumpe</option>
                <option value="Holzpelletheizung">Holzpelletheizung</option>
                <option value="Andere">Andere</option>
            </select>

            <label for="zustand">Zustand:</label>
            <select id="zustand">
                <option value="Gepflegt">Gepflegt</option>
                <option value="Erstbezug">Erstbezug</option>
                <option value="Saniert">Saniert</option>
                <option value="Vollstaendig renoviert">Vollstaendig renoviert</option>
                <option value="Neuwertig">Neuwertig</option>
                <option value="Modernisiert">Modernisiert</option>
                <option value="Erstbezug nach Sanierung">Erstbezug nach Sanierung</option>
                <option value="Andere">Andere</option>
            </select>

            <label for="qualitaet">Innenausstattung:</label>
            <select id="qualitaet">
                <option value="Normal">Normal</option>
                <option value="Gehoben">Gehoben</option>
                <option value="Luxus">Luxus</option>
                <option value="Einfach">Einfach</option>
            </select>

            <label>Ausstattung:</label>
            <div class="checkbox-row">
                <label><input type="checkbox" id="balkon"> Balkon</label>
                <label><input type="checkbox" id="lift"> Lift</label>
                <label><input type="checkbox" id="kueche"> Kueche</label>
                <label><input type="checkbox" id="garten"> Garten</label>
                <label><input type="checkbox" id="keller"> Keller</label>
            </div>

            <label for="datum">Datum (optional):</label>
            <input type="date" id="datum">

            <button type="submit">Suchen</button>
            <div id="result" class="result"></div>
            <div id="error" class="error"></div>
        </form>
    </div>

    <script>
        const bundeslandSelect = document.getElementById("bundesland");
        const stadtSelect = document.getElementById("stadt");
        const plzInput = document.getElementById("plz");
        const plzList = document.getElementById("plzList");
        const plzHelp = document.getElementById("plzHelp");
        const resultBox = document.getElementById("result");
        const errorBox = document.getElementById("error");

        let geoData = {};
        const plzIndex = new Map();

        function getLabel(value) {
            return String(value).replace(/_/g, " ");
        }

        function clearSelect(select, placeholder) {
            select.innerHTML = "";
            const option = document.createElement("option");
            option.value = "";
            option.textContent = placeholder;
            select.appendChild(option);
        }

        function buildPlzIndex(data) {
            Object.keys(data).forEach(stateKey => {
                const cities = data[stateKey];
                Object.keys(cities).forEach(cityKey => {
                    cities[cityKey].forEach(plz => {
                        if (!plzIndex.has(plz)) {
                            plzIndex.set(plz, { stateKey, cityKey });
                        }
                    });
                });
            });
        }

        function populateStates() {
            clearSelect(bundeslandSelect, "-- Bitte waehlen --");
            const stateKeys = Object.keys(geoData).sort();
            stateKeys.forEach(stateKey => {
                const option = document.createElement("option");
                option.value = stateKey;
                option.textContent = getLabel(stateKey);
                bundeslandSelect.appendChild(option);
            });
            bundeslandSelect.disabled = false;
        }

        function populateCities(stateKey) {
            clearSelect(stadtSelect, "-- Bitte waehlen --");
            if (!stateKey || !geoData[stateKey]) {
                stadtSelect.disabled = true;
                plzInput.disabled = true;
                return;
            }
            const cityKeys = Object.keys(geoData[stateKey]).sort();
            cityKeys.forEach(cityKey => {
                const option = document.createElement("option");
                option.value = cityKey;
                option.textContent = getLabel(cityKey);
                stadtSelect.appendChild(option);
            });
            stadtSelect.disabled = false;
        }

        function populatePlzList(stateKey, cityKey) {
            plzList.innerHTML = "";
            if (!stateKey || !cityKey || !geoData[stateKey] || !geoData[stateKey][cityKey]) {
                plzInput.value = "";
                plzInput.disabled = true;
                return;
            }
            const plzs = geoData[stateKey][cityKey].slice().sort();
            plzs.forEach(plz => {
                const option = document.createElement("option");
                option.value = plz;
                plzList.appendChild(option);
            });
            plzInput.disabled = false;
        }

        function setPlzHelp(message, isError) {
            plzHelp.textContent = message;
            plzHelp.classList.toggle("error-text", Boolean(isError));
        }

        function isPlzValidForSelection(stateKey, cityKey, plz) {
            if (!stateKey || !cityKey || !plz || !geoData[stateKey] || !geoData[stateKey][cityKey]) {
                return false;
            }
            return geoData[stateKey][cityKey].includes(plz);
        }

        function onStateChange() {
            const stateKey = bundeslandSelect.value;
            populateCities(stateKey);
            populatePlzList(stateKey, "");
            plzInput.value = "";
            setPlzHelp("");
        }

        function onCityChange() {
            const stateKey = bundeslandSelect.value;
            const cityKey = stadtSelect.value;
            populatePlzList(stateKey, cityKey);
            if (plzInput.value && !isPlzValidForSelection(stateKey, cityKey, plzInput.value)) {
                plzInput.value = "";
            }
            setPlzHelp("");
        }

        function onPlzInput() {
            const plzValue = plzInput.value.trim();
            if (plzValue.length !== 5) {
                setPlzHelp("");
                return;
            }
            const match = plzIndex.get(plzValue);
            if (!match) {
                setPlzHelp("PLZ nicht gefunden.", true);
                return;
            }
            if (bundeslandSelect.value !== match.stateKey) {
                bundeslandSelect.value = match.stateKey;
                populateCities(match.stateKey);
            }
            if (stadtSelect.value !== match.cityKey) {
                stadtSelect.value = match.cityKey;
            }
            populatePlzList(match.stateKey, match.cityKey);
            setPlzHelp("PLZ passt zu Auswahl.", false);
        }

        fetch("geo_data.json")
            .then(response => response.json())
            .then(data => {
                geoData = data || {};
                buildPlzIndex(geoData);
                populateStates();
            })
            .catch(() => {
                setPlzHelp("Geo-Daten konnten nicht geladen werden.", true);
            });

        bundeslandSelect.addEventListener("change", onStateChange);
        stadtSelect.addEventListener("change", onCityChange);
        plzInput.addEventListener("input", onPlzInput);

        function setResult(message) {
            resultBox.textContent = message;
            resultBox.style.display = "block";
        }

        function setError(message) {
            errorBox.textContent = message;
        }

        function clearMessages() {
            resultBox.style.display = "none";
            resultBox.textContent = "";
            errorBox.textContent = "";
        }

        document.getElementById("searchForm").addEventListener("submit", (event) => {
            event.preventDefault();
            clearMessages();

            const payload = {
                livingSpace: Number(document.getElementById("flaeche").value),
                noRooms: Number(document.getElementById("zimmer").value),
                floor: Number(document.getElementById("etage").value),
                yearConstructed: Number(document.getElementById("baujahr").value),
                regio1: bundeslandSelect.value,
                regio2: stadtSelect.value,
                geo_plz: plzInput.value.trim(),
                heatingType: document.getElementById("heizung").value,
                condition: document.getElementById("zustand").value,
                interiorQual: document.getElementById("qualitaet").value,
                typeOfFlat: document.getElementById("typ").value,
                balcony: document.getElementById("balkon").checked,
                lift: document.getElementById("lift").checked,
                hasKitchen: document.getElementById("kueche").checked,
                garden: document.getElementById("garten").checked,
                cellar: document.getElementById("keller").checked,
                date: document.getElementById("datum").value || null,
            };

            if (!payload.regio1 || !payload.regio2 || !payload.geo_plz) {
                setError("Bitte Bundesland, Stadt und PLZ auswaehlen.");
                return;
            }

            if (Number.isNaN(payload.livingSpace) || Number.isNaN(payload.noRooms) || Number.isNaN(payload.floor) || Number.isNaN(payload.yearConstructed)) {
                setError("Bitte alle Zahlenfelder ausfuellen.");
                return;
            }

            fetch("/predict", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            })
                .then(response => response.json().then(data => ({ ok: response.ok, data })))
                .then(({ ok, data }) => {
                    if (!ok) {
                        setError(data.detail || "Vorhersage fehlgeschlagen.");
                        return;
                    }
                    const value = Number(data.prediction);
                    const formatted = Number.isFinite(value) ? value.toLocaleString("de-DE", { maximumFractionDigits: 0 }) : data.prediction;
                    setResult(`Geschaetzte Miete: ${formatted}`);
                })
                .catch(() => {
                    setError("Vorhersage fehlgeschlagen.");
                });
        });
    </script>

</body>

</html>
